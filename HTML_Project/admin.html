<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golden Bite Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-color: #0B1315;
            --accent-color: #CB9953;
            --gray-color: #6A5E5C;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f8f8;
        }

        .navbar {
            background-color: var(--main-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand, .nav-link {
            color: white !important;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--accent-color) !important;
        }

        .dashboard-header {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .dashboard-header h3 {
            color: var(--main-color);
        }

        .dashboard-header p {
            color: var(--gray-color);
        }

        .content-area {
            min-height: 300px;
        }
        .page-wrapper {
            transform: scale(0.85); /* تصغير بنسبة 85% */
            transform-origin: top center; /* يكون التصغير من أعلى الصفحة */
        }

        @media (max-width: 768px) {
            .page-wrapper {
                transform: scale(1); /* على الموبايل ما نصغر */
            }
        }
        canvas {
            max-width: 100%;
            height: 250px !important; /* أو أي ارتفاع أصغر من الحالي */
        }
        #reservationsTableContainer table {
            width: 100%;
            border-collapse: collapse;
            border: 2px solid #333;
        }

        #reservationsTableContainer th,
        #reservationsTableContainer td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }

        #usersTable, #usersTable th, #usersTable td {
            border: 1px solid #333; /* نوع الحدود ولونها */
            border-collapse: collapse; /* حتى تكون الحدود متصلة */
            padding: 8px; /* تباعد داخل الخلايا */
        }
        #messagesTableContainer table {
            width: 100%;
            border-collapse: collapse; /* تدمج حدود الخلايا بشكل مرتب */
            border: 2px solid #333; /* حد خارجي للجدول */
        }

        #messagesTableContainer th,
        #messagesTableContainer td {
            border: 1px solid #333; /* حدود داخلية للخلايا */
            padding: 10px;
            text-align: center;
        }


    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.php">
            <i class="fas fa-utensils me-2"></i>Golden Restaurant Admin
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="dashboardLink">
                        <i class="fas fa-chart-line me-1"></i> Dashboard
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" id="reservationsLink" href="#">
                        <i class="fas fa-calendar-check me-1"></i> Reservations
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="shop.php">
                        <i class="fas fa-store me-1"></i> Shop
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="#" id="usersLink">
                        <i class="fas fa-users-cog me-1"></i> Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="messagesLink">
                        <i class="fas fa-envelope me-1"></i> Messages
                    </a>
                </li>

            </ul>
        </div>
    </div>
</nav>
<div class="page-wrapper">

<div class="container py-4">
    <div class="dashboard-header">
        <h3><i class="fas fa-chart-line me-2"></i>Dashboard</h3>
        <p class="mb-0">Welcome! You can manage Golden Bite statistics here.</p>
    </div>

    <!-- Stats Boxes -->
    <div class="row" id="stats-container">
        <!-- Boxes will be inserted here by JS -->
    </div>
</div>
<!-- Charts Section -->
<div class="row mt-4">
    <!-- Bar Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Reservations Overview</h5>
                <canvas id="reservationsChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Pie Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title">Coupons Usage</h5>
                <canvas id="couponsChart"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Line Chart --><canvas id="usersLineChart" height="100"></canvas>
</div>








<div id="reservationsContent" style="display:none; padding: 20px;">
    <button id="backToDashboardBtn" class="btn btn-secondary mb-3" style="color: #FFFFFF">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
    </button>

    <div id="reservationsTableContainer">
        <!-- Reservation table will be loaded here -->
    </div>

    <!-- Edit Modal -->
    <div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); justify-content:center; align-items:center;">
        <div style="background:#fff; padding:20px; border-radius:8px; width:400px; position:relative;">
            <h3>Edit Reservation</h3>
            <form id="editForm">
                <input type="hidden" id="editId" />

                <label>Email:</label><br>
                <input type="email" id="editEmail" class="form-control" readonly>

                <label>Name:</label><br>
                <input type="text" id="editName" class="form-control" readonly>

                <label>Date:</label><br>
                <input type="date" id="editDate" required style="width:100%; margin-bottom:10px;" /><br>

                <label>Time:</label><br>
                <input type="time" id="editTime" required style="width:100%; margin-bottom:10px;" /><br>

                <label>Number of Guests:</label><br>
                <input type="number" id="editGuests" required min="1" style="width:100%; margin-bottom:10px;" /><br>

                <label>Special Requests:</label><br>
                <textarea id="editSpecialRequest" rows="3" style="width:100%; margin-bottom:10px;"></textarea><br>

                <button type="submit" style="background:#007bff; color:#fff; padding:8px 15px; border:none; border-radius:5px; cursor:pointer;">Save</button>
                <button type="button" id="closeModal" style="background:#ccc; color:#000; padding:8px 15px; border:none; border-radius:5px; cursor:pointer; margin-left:10px;">Cancel</button>
            </form>
        </div>
    </div>
</div>







<div id="usersContent" style="display:none; padding: 20px;">
    <button id="backToDashboardFromUsersBtn" class="btn btn-secondary mb-3">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
    </button>

    <table id="usersTable" class="table">
        <thead>
        <tr>
            <th>id</th>
            <th>name</th>
            <th>email</th>
            <th>password</th>
            <th>created_at</th>
            <th>role</th>
            <th>delete</th>
        </tr>
        </thead>
        <tbody>
        <!-- هنا جدول المستخدمين -->
        </tbody>
    </table>
</div>






<!-- قسم عرض الرسائل -->
<div id="messagesContent" style="display:none; padding: 20px;">
    <button id="backToDashboardFromMessagesBtn" class="btn btn-secondary mb-3">
        <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
    </button>

    <div id="messagesTableContainer">
        <!-- هنا سيتم تحميل قائمة الرسائل -->
    </div>
</div>
<!-- Reply Modal -->
<div id="replyModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
">
    <div class="bg-white p-4 rounded shadow" style="width: 450px; position: relative;">
        <h4 class="mb-3 text-center">Reply to Message</h4>
        <form id="replyForm">
            <input type="hidden" name="message_id" id="message_id" value="">

            <div class="mb-3">
                <label for="email" class="form-label">Email Address:</label>
                <input type="email" name="email" id="email" class="form-control" readonly>
            </div>

            <div class="mb-3">
                <label for="reply_text" class="form-label">Your Reply:</label>
                <textarea name="reply_text" id="reply_text" rows="4" class="form-control" required></textarea>
            </div>

            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">Send Reply</button>
                <button type="button" id="closeReplyModal" class="btn btn-secondary ms-2">Cancel</button>
            </div>
        </form>

        <div id="responseMessage" class="mt-3"></div>
    </div>
</div>








<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>


    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('replyModal').style.display = 'none';
    });

//    document.getElementById('reservationsLink').addEventListener('click', function(e) {
//        e.preventDefault(); // لمنع التنقل بالرابط
//        document.querySelector('.page-wrapper').style.display = 'none'; // نخفي الإحصائيات كلها
//        document.getElementById('reservationsContent').style.display = 'block'; // نعرض محتوى الحجوزات
//    });
//
//    // زر الرجوع للإحصائيات
//    document.getElementById('backToDashboardBtn').addEventListener('click', function() {
//        document.getElementById('reservationsContent').style.display = 'none'; // نخفي الحجوزات
//        document.querySelector('.page-wrapper').style.display = 'block'; // نعيد عرض الإحصائيات
//    });
// دالة لإخفاء كل الأقسام
function hideAllSections() {
    document.querySelector('.dashboard-header').style.display = 'none';
    document.getElementById('stats-container').style.display = 'none';
    document.querySelector('.row.mt-4').style.display = 'none';  // Charts
    document.getElementById('usersLineChart').style.display = 'none';
    document.getElementById('replyModal').style.display = 'none'; // مهم إخفاء المودال

    document.getElementById('reservationsContent').style.display = 'none';
    document.getElementById('usersContent').style.display = 'none';
    document.getElementById('messagesContent').style.display = 'none';  // **أضفت هذا السطر**
}


// عرض داشبورد
document.getElementById('dashboardLink').addEventListener('click', e => {
    e.preventDefault();
    hideAllSections();
    document.querySelector('.dashboard-header').style.display = 'block';
    document.getElementById('stats-container').style.display = 'flex';
    document.querySelector('.row.mt-4').style.display = 'flex';
    document.getElementById('usersLineChart').style.display = 'block';
    document.getElementById('replyModal').style.display = 'none'; // هذا مهم

    // تعديل تفعيل الروابط بالنافبار
    setActiveNav('dashboardLink');
});

// عرض قسم الحجز
document.getElementById('reservationsLink').addEventListener('click', e => {
    e.preventDefault();
    hideAllSections();
    document.getElementById('reservationsContent').style.display = 'block';
    setActiveNav('reservationsLink');
    document.getElementById('replyModal').style.display = 'none'; // هذا مهم

});


// عرض قسم المستخدمين
document.getElementById('usersLink').addEventListener('click', e => {
    e.preventDefault();
    hideAllSections();
    document.getElementById('usersContent').style.display = 'block';

    // جلب بيانات المستخدمين (ممكن جلبها من API أو PHP)
    loadUsers();


    setActiveNav('usersLink');
    document.getElementById('replyModal').style.display = 'none'; // هذا مهم

});

// زر الرجوع من الحجز للداشبورد
document.getElementById('backToDashboardBtn').addEventListener('click', () => {
    document.getElementById('reservationsContent').style.display = 'none';
    document.querySelector('.dashboard-header').style.display = 'block';
    document.getElementById('stats-container').style.display = 'flex';
    document.querySelector('.row.mt-4').style.display = 'flex';
    document.getElementById('replyModal').style.display = 'none'; // هذا مهم

    document.getElementById('usersLineChart').style.display = 'block';

    setActiveNav('dashboardLink');
});

// زر الرجوع من المستخدمين للداشبورد
document.getElementById('backToDashboardFromUsersBtn').addEventListener('click', () => {
    document.getElementById('usersContent').style.display = 'none';
    document.querySelector('.dashboard-header').style.display = 'block';
    document.getElementById('stats-container').style.display = 'flex';
    document.querySelector('.row.mt-4').style.display = 'flex';
    document.getElementById('replyModal').style.display = 'none'; // هذا مهم

    document.getElementById('usersLineChart').style.display = 'block';

    setActiveNav('dashboardLink');
});
// عرض قسم الرسائل
document.getElementById('messagesLink').addEventListener('click', e => {
    e.preventDefault();
    hideAllSections();
    document.getElementById('messagesContent').style.display = 'block';

    loadMessages(); // راح نكتبها بعد شوي
    setActiveNav('messagesLink');
});

// زر الرجوع من الرسائل للداشبورد
document.getElementById('backToDashboardFromMessagesBtn').addEventListener('click', () => {
    document.getElementById('messagesContent').style.display = 'none';
    document.querySelector('.dashboard-header').style.display = 'block';
    document.getElementById('stats-container').style.display = 'flex';
    document.querySelector('.row.mt-4').style.display = 'flex';
    document.getElementById('usersLineChart').style.display = 'block';

    setActiveNav('dashboardLink');
});


// تحديث رابط مفعّل
function setActiveNav(id) {
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

    document.addEventListener("DOMContentLoaded", () => {
        fetch("../PHP_Admin/admin_stats.php")
            .then(res => res.json())
            .then(data => {
                const stats = [
                    {
                        icon: "fa-calendar-day",
                        label: "Today's Reservations",
                        value: data.reservations_today,
                        color: "#CB9953"
                    },
                    {
                        icon: "fa-calendar-week",
                        label: "This Week's Reservations",
                        value: data.reservations_week,
                        color: "#6A5E5C"
                    },
                    {
                        icon: "fa-users",
                        label: "Total Users",
                        value: data.users_count,
                        color: "#0B1315"
                    },
                    {

                        icon: "fa-ticket-alt",
                        label: "Used Coupons",
                        value: data.used_coupons,
                        color: "#CB9953"
                    },
                    {
                        icon: "fa-ticket",
                        label: "New Coupons",
                        value: data.new_coupons,
                        color: "#6A5E5C"
                    }
                ];

                const container = document.getElementById("stats-container");
                stats.forEach(stat => {
                    const col = document.createElement("div");
                    col.className = "col-md-6 col-lg-4 mb-4";

                    col.innerHTML = `
            <div class="card shadow-sm border-0 h-100">
              <div class="card-body d-flex align-items-center">
                <div class="me-3">
                  <i class="fas ${stat.icon} fa-2x" style="color: ${stat.color};"></i>
                </div>
                <div>
                  <h6 class="mb-1">${stat.label}</h6>
                  <h4 class="mb-0" style="color: var(--main-color); font-weight: bold;">${stat.value}</h4>
                </div>
              </div>
            </div>
          `;
                    container.appendChild(col);
                });
            })
            .catch(error => {
                console.error("Error loading statistics:", error);
            });
    });
    document.addEventListener("DOMContentLoaded", () => {
        fetch("../PHP_Admin/admin_stats.php")
            .then(res => res.json())
            .then(data => {
                // Bar Chart: Reservations
                const ctx1 = document.getElementById('reservationsChart').getContext('2d');
                new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ['Today', 'This Week'],
                        datasets: [{
                            label: 'Reservations',
                            data: [data.reservations_today, data.reservations_week],
                            backgroundColor: ['#CB9953', '#6A5E5C']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });

                // Pie Chart: Coupons
                const ctx2 = document.getElementById('couponsChart').getContext('2d');
                new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Used Coupons', 'New Coupons'],
                        datasets: [{
                            data: [data.used_coupons, data.new_coupons],
                            backgroundColor: ['#CB9953', '#0B1315']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            });
    });
    document.addEventListener("DOMContentLoaded", function () {
        fetch("../PHP_Admin/admin_stats.php")
            .then(response => response.json())
            .then(data => {
                const ctx3 = document.getElementById('usersLineChart').getContext('2d');
                const usersLabels = Object.keys(data.users_last_week);
                const usersData = Object.values(data.users_last_week);

                new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: usersLabels,
                        datasets: [{
                            label: 'New Users',
                            data: usersData,
                            fill: false,
                            borderColor: '#CB9953',
                            backgroundColor: '#CB9953',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            });
    });




    // ===================================================================
    function renderTable(data) {
        if (data.length === 0) {
            document.getElementById('reservationsTableContainer').innerHTML = '<p>لا توجد حجوزات.</p>';
            return;
        }

        let html = `<table style="width:100%; border-collapse: collapse; border: 2px solid #333;">
        <thead><tr>`;

        const columns = ['id', 'email', 'name', 'date', 'time', 'guests', 'special_request'];

        columns.forEach(key => {
            html += `<th style="border:1px solid #333; padding:8px; text-align:center;">${key}</th>`;
        });

        html += `<th style="border:1px solid #333; padding:8px; text-align:center;">Edit</th>
         <th style="border:1px solid #333; padding:8px; text-align:center;">Delete</th>
         </tr></thead><tbody>`;


        data.forEach(row => {
            html += '<tr>';

            columns.forEach(key => {
                html += `<td style="border:1px solid #333; padding:8px; text-align:center;">${row[key]}</td>`;
            });

            html += `<td style="border:1px solid #333; padding:8px; text-align:center;">
            <button class="editBtn" data-id="${row.id}" title="Edit" style="background:none; border:none; cursor:pointer; font-size:18px; color:#007bff;">
                <i class="fas fa-edit"></i>
            </button>
        </td>`;

            html += `<td style="border:1px solid #333; padding:8px; text-align:center;">
            <button class="deleteBtn" data-id="${row.id}" title="Delete" style="background:none; border:none; cursor:pointer; font-size:18px; color:red;">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>`;


            html += '</tr>';
        });

        html += '</tbody></table>';
        document.getElementById('reservationsTableContainer').innerHTML = html;

        // Delete
        document.querySelectorAll('.deleteBtn').forEach(btn => {
            btn.onclick = () => {
                if (confirm('Are you sure you want to delete?')) {
                    deleteReservation(btn.dataset.id);
                }
            };
        });


        // تعديل
        document.querySelectorAll('.editBtn').forEach(btn => {
            btn.onclick = () => {
                const row = btn.closest('tr');
                document.getElementById('editId').value = row.children[0].textContent;
                document.getElementById('editEmail').value = row.children[1].textContent;
                document.getElementById('editName').value = row.children[2].textContent;
                document.getElementById('editDate').value = row.children[3].textContent;
                document.getElementById('editTime').value = row.children[4].textContent;
                document.getElementById('editGuests').value = row.children[5].textContent;
                document.getElementById('editSpecialRequest').value = row.children[6].textContent;

                editModal.style.display = 'flex';
            };
        });
    }

function fetchReservations() {
    fetch('../PHP_Admin/reservations.php')
        .then(res => res.json())
        .then(data => renderTable(data))
        .catch(() => {
            document.getElementById('reservationsTableContainer').innerHTML = 'An error occurred while loading the data';
        });
}

function deleteReservation(id) {
    fetch(`../PHP_Admin/delete_reservation.php?id=${id}`, {
        method: 'GET'
    })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert('Reservation deleted successfully');
                fetchReservations();
            } else {
                alert('Failed to delete');
            }
        })
        .catch(() => {
            alert('An error occurred while deleting');
        });
}

// مودال التعديل
    const editModal = document.getElementById('editModal');
    const closeModalBtn = document.getElementById('closeModal');
    closeModalBtn.onclick = () => {
        editModal.style.display = 'none';
    };

    // تحديث الحجز
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const data = {
            id: document.getElementById('editId').value.trim(),
            email: document.getElementById('editEmail').value.trim(),
            name: document.getElementById('editName').value.trim(),
            date: document.getElementById('editDate').value,
            time: document.getElementById('editTime').value,
            guests: document.getElementById('editGuests').value,
            special_request: document.getElementById('editSpecialRequest').value.trim(),
        };

        fetch('../PHP_Admin/update_reservation.php', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        })
            .then(res => res.json())
            .then(resData => {
                if (resData.success) {
                    alert('Reservation updated successfully');
                    editModal.style.display = 'none';
                    fetchReservations();
                } else {
                    alert('Error: ' + (resData.message || 'Unknown error'));
                }
            })
            .catch(() => alert('Error connecting to the server'));
    });

        // تحميل الحجوزات عند تحميل الصفحة
    fetchReservations();
    // ********************************************************
function loadUsers() {
    $.ajax({
        url: '../PHP_Admin/user.php', // رابط ملف PHP اللي يجيب بيانات المستخدمين JSON
        method: 'GET',
        dataType: 'json',
        success: function(users) {
            let tbody = '';
            users.forEach(user => {
                tbody += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.password}</td>
                        <td>${user.created_at}</td>
                        <td>${user.role}</td>
                        <td>
  <button class="btn btn-danger btn-sm delete-btn" data-id="${user.id}">
    <i class="fas fa-trash-alt"></i>
  </button>
</td>
</button>
                    </tr>
                `;
            });
            $('#usersTable tbody').html(tbody);
        },
        error: function() {
            alert('Failed to load user data');
        }

    });
}
$(document).ready(function() {
    loadUsers();

    // Delete event when clicking the delete button
    $('#usersTable').on('click', '.delete-btn', function() {
        if (!confirm('Are you sure you want to delete the user?')) return;

        let userId = $(this).data('id');
        $.ajax({
            url: '../PHP_Admin/delete_user.php?id=' + userId,  // Your delete PHP file URL
            method: 'GET',
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert('User deleted successfully');
                    loadUsers(); // Reload the table
                } else {
                    alert('Deletion failed: ' + (response.message || 'An error occurred'));
                }
            },
            error: function() {
                alert('Error occurred while communicating with the server');
            }
        });
    });
});



//
// ==========================================================
// ==========================================================
// تحميل الرسائل وعرضها مع زر رد لكل رسالة
// Load messages
function loadMessages() {
    $('#messagesTableContainer').html('');
    $.ajax({
        url: '../PHP_Admin/get_messages.php',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            if (data.length === 0) {
                $('#messagesTableContainer').html('<p style="color: #777; text-align: center;">No new messages</p>');
                return;
            }

            let html = '<table border="1" cellpadding="10" cellspacing="0" width="100%">';
            html += '<thead><tr><th>Name</th><th>Email</th><th>Message</th><th>Time</th><th>Reply</th></tr></thead><tbody>';

            data.forEach(msg => {
                html += `<tr>
          <td>${msg.name}</td>
          <td>${msg.email}</td>
          <td>${msg.message}</td>
          <td>${msg.created_at}</td>
<td>
  <button class="reply-btn" data-id="${msg.id}" data-email="${msg.email}" title="Reply" style="background:none; border:none; cursor:pointer; color:#007bff; font-size:18px;">
    <i class="fas fa-reply"></i>
  </button>
</td>
        </tr>`;
            });

            html += '</tbody></table>';
            $('#messagesTableContainer').html(html);
        },
        error: function() {
            $('#messagesTableContainer').html('<p style="color: red; text-align: center;">Failed to load messages</p>');
        }
    });
}

// Open reply modal and fill in data
$(document).on('click', '.reply-btn', function() {
    const messageId = $(this).data('id');
    const email = $(this).data('email');

    $('#message_id').val(messageId);
    $('#email').val(email);
    $('#reply_text').val('');
    $('#responseMessage').text('');
    $('#replyModal').fadeIn();
});

// Close modal
$('#closeReplyModal').click(function() {
    $('#replyModal').fadeOut();
});

// Send reply
$('#replyForm').on('submit', function(e) {
    e.preventDefault();

    const message_id = $('#message_id').val();
    const email = $('#email').val();
    const reply_text = $('#reply_text').val();

    $.ajax({
        url: '../PHP_Admin/save_reply.php',
        method: 'POST',
        dataType: 'json',
        data: { message_id, email, reply_text },
        success: function(response) {
            if (response.status === 'success') {
                $('#responseMessage').css('color', 'green').text(response.message);
                $('#reply_text').val('');
                loadReplies(); // If you have a function to load replies, refresh it
                $('#replyModal').fadeOut();
            } else {
                $('#responseMessage').css('color', 'red').text(response.message);
            }
        },
        error: function() {
            $('#responseMessage').css('color', 'red').text('An error occurred while sending.');
        }
    });
});

// Load replies with the original message
function loadReplies() {
    $.ajax({
        url: '../PHP_Project/get_replies.php',
        method: 'GET',
        dataType: 'json',
        success: function(data) {
            if (data.length === 0) {
                $('#repliesContainer').html('<p style="color: #777; text-align: center;">No replies yet</p>');
                return;
            }

            let content = '';
            data.forEach(reply => {
                content += `
          <div class="reply-box" style="border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:8px;">
            <p><strong>Original Message:</strong><br>${reply.message}</p>
            <p><strong>Sent Reply:</strong><br>${reply.reply_text}</p>
            <p style="font-size:13px; color:#888;"><i class="fas fa-clock"></i> ${reply.created_at}</p>
          </div>
        `;
            });

            $('#repliesContainer').html(content);
        },
        error: function() {
            $('#repliesContainer').html('<p style="color: red; text-align: center;">Failed to load replies.</p>');
        }
    });
}

// On page load
$(document).ready(function() {
    loadMessages();
    loadReplies();
});




</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
